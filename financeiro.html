async function transferPaymentViaAPI(paymentId) {
    if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o far√° uma transfer√™ncia REAL via Mercado Pago.\n\nConfirma que deseja transferir este valor para o canal?')) {
        return;
    }
    
    showLoading();
    try {
        const paymentRef = db.collection('payment_history').doc(paymentId);
        const paymentDoc = await paymentRef.get();
        
        if (!paymentDoc.exists) throw new Error('Pagamento n√£o encontrado');
        
        const payment = paymentDoc.data();
        
        if (payment.status !== 'received' && payment.status !== 'approved') {
            showAlert('‚ùå Este pagamento n√£o est√° com status "recebido".', 'error');
            hideLoading();
            return;
        }
        
        if (payment.transferStatus === 'paid') {
            showAlert('‚ùå Este pagamento j√° foi repassado.', 'error');
            hideLoading();
            return;
        }
        
        const channelUserId = payment.channelUserId || payment.metadata?.channelUserId;
        const channelAmount = payment.split?.channel || ((payment.amount || 0) * 0.92);
        
        if (!channelUserId) {
            showAlert('‚ùå N√£o foi poss√≠vel identificar o destinat√°rio.', 'error');
            hideLoading();
            return;
        }
        
        if (channelAmount <= 0) {
            showAlert('‚ùå Valor a transferir inv√°lido.', 'error');
            hideLoading();
            return;
        }
        
        // BUSCAR TOKEN DO CANAL
        const channelDoc = await db.collection('channels').doc(payment.channelId).get();
        if (!channelDoc.exists) throw new Error('Canal n√£o encontrado');
        
        const channelData = channelDoc.data();
        const channelToken = channelData?.pixDonations?.mpAccessToken;
        
        if (!channelToken) {
            showAlert('‚ùå Token do Mercado Pago n√£o encontrado para este canal.', 'error');
            hideLoading();
            return;
        }
        
        // ‚úÖ FAZER TRANSFER√äNCIA VIA API DO MERCADO PAGO
        showAlert('üîÑ Iniciando transfer√™ncia via Mercado Pago...', 'info');
        
        const transferData = {
            amount: channelAmount,
            user_id: channelUserId.toString()
        };
        
        const response = await fetch('https://api.mercadopago.com/v1/transfers', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${channelToken}`,
                'Content-Type': 'application/json',
                'X-Idempotency-Key': `transfer_${Date.now()}_${paymentId}`
            },
            body: JSON.stringify(transferData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.id) {
            // ‚úÖ SUCESSO
            await paymentRef.update({
                transferStatus: 'paid',
                transferredAt: firebase.firestore.FieldValue.serverTimestamp(),
                transferId: result.id,
                transferNotes: `Transferido via API MP por ${currentUser.email} em ${new Date().toLocaleString('pt-BR')}`,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // ATUALIZAR PENDING_TRANSFERS SE EXISTIR
            const transferQuery = await db.collection('pending_transfers')
                .where('paymentId', '==', payment.paymentId || paymentId.replace('payment_', ''))
                .get();
            
            if (!transferQuery.empty) {
                await transferQuery.docs[0].ref.update({
                    transferStatus: 'paid',
                    transferId: result.id,
                    paymentDate: firebase.firestore.FieldValue.serverTimestamp(),
                    notes: `Transferido via API MP por ${currentUser.email}`
                });
            }
            
            await loadDashboardData();
            showAlert(`‚úÖ Transfer√™ncia REALIZADA!\nID: ${result.id}\nValor: R$ ${channelAmount.toFixed(2)}`, 'success');
            document.getElementById('paymentModal').style.display = 'none';
        } else {
            throw new Error(result.message || 'Erro na transfer√™ncia');
        }
        
        hideLoading();
    } catch (error) {
        console.error('Erro na transfer√™ncia:', error);
        showAlert(`‚ùå Falha na transfer√™ncia: ${error.message}`, 'error');
        hideLoading();
    }
}
